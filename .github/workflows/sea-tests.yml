on: [push]
name: Docker Tests

jobs:
  install-docker:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        os-name: [bionic, centos8, centos7, centos6, fedora32, xenial]
    name: Test in {{ matrix.os-name }}
    steps:
      - run: docker --version
      - name: Git checkout
        uses: actions/checkout@v2
      - run: DOCKERFILE=tests/docker/Dockerfile.{{ matrix.os-name }} && TAGNAME={{ matrix.os-name }}
      - run: cd ${{ github.workspace }}
      - run: docker build tests/docker -f ${DOCKERFILE} -t imagetest:${TAGNAME}
      - run: docker run --rm -v $PWD:$PWD -w $PWD imagetest:${TAGNAME} make clean
      - run: docker run --rm -v $PWD:$PWD -w $PWD imagetest:${TAGNAME} make test debug_opts="-g -ggdb --coverage -fprofile-arcs -ftest-coverage"
      - run: docker run --rm -v $PWD:$PWD -w $PWD imagetest:${TAGNAME} bats tests/tests.bats
      - run: docker run --rm -v $PWD:$PWD -w $PWD -e SEA_HOME=$PWD imagetest:${TAGNAME} tests/test_custom


